<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Manager - Auto Scroll</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root { --primary: #007bff; --success: #28a745; --info: #17a2b8; --warning: #ffc107; --danger: #dc3545; --purple: #6f42c1; --dark: #343a40; --grey: #6c757d; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f8f9fa; scroll-behavior: smooth; }
        .sticky-header { position: sticky; top: 0; z-index: 1000; background: white; padding: 10px 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .content-area { padding: 15px; }
        .table-container { width: 100%; overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 12px; text-align: center; border: 1px solid #eee; font-size: 13px; }
        th { background-color: #f1f5f9; color: #4a5568; text-transform: uppercase; font-size: 11px; }
        button { padding: 8px 12px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 12px; color: white; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        .counter-badge { background: #e2e8f0; padding: 6px 10px; border-radius: 6px; font-weight: bold; font-size: 12px; color: var(--dark); }
        .dropdown { position: relative; }
        .dropdown-content { display: none; position: absolute; background-color: white; min-width: 140px; box-shadow: 0px 8px 16px rgba(0,0,0,0.1); z-index: 1001; border-radius: 6px; border: 1px solid #ddd; }
        .dropdown-content button { width: 100%; border-radius: 0; background: white; color: #333; text-align: left; border-bottom: 1px solid #eee; }
        .show { display: block; }
        .search-container { margin-left: auto; display: flex; align-items: center; gap: 5px; background: #f1f5f9; padding: 5px 10px; border-radius: 8px; border: 1px solid #ddd; }
        .highlight-row { background-color: #fff3cd !important; outline: 2px solid var(--warning); }
        .comm-input { padding: 6px; border: 2px solid var(--primary); border-radius: 4px; width: 160px; }
        .panel { display: none; margin-bottom: 30px; padding: 20px; border-radius: 12px; background: white; border: 2px solid #eee; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); border-radius: 10px; z-index: 1100; width: 90%; max-width: 350px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1050; }
        #syncLoader { font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

<div class="sticky-header">
    <button style="background:var(--primary)" onclick="showModal('uploadModal')">‚ûï Upload</button>
    <button style="background:var(--purple)" onclick="toggleAndScroll('historySection')">üìã Files</button>
    <button style="background:var(--warning); color:black" onclick="toggleAndScroll('recycleBinSection')">üóëÔ∏è Bin</button>
    
    <div class="dropdown">
        <button style="background:var(--dark)" onclick="toggleDropdown()">üì• Export ‚ñº</button>
        <div id="dlMenu" class="dropdown-content">
            <button onclick="openExportModal('excel')">Excel</button>
            <button onclick="openExportModal('pdf')">PDF</button>
            <button onclick="window.print()">Print</button>
        </div>
    </div>

    <button style="background:var(--info)" onclick="syncData()">üîÑ Sync</button>
    <button style="background:var(--grey)" onclick="toggleAndScroll('settingsSection')">‚öôÔ∏è Settings</button>
    
    <span id="syncLoader">Checking...</span>
    <div class="counter-badge">Active: <span id="activeCount">0</span></div>
    
    <div class="search-container">
        <input type="text" id="searchInput" oninput="initSearch()" placeholder="Search data..." style="border:none; background:transparent; outline:none; width:120px;">
        <span id="searchCount" style="font-size:11px;">0/0</span>
        <button style="padding:2px 6px; background:#ddd; color:black;" onclick="navSearch(-1)">‚ñ≤</button>
        <button style="padding:2px 6px; background:#ddd; color:black;" onclick="navSearch(1)">‚ñº</button>
    </div>
</div>

<div class="content-area">
    <div id="settingsSection" class="panel">
        <h3 style="margin-top:0; color:var(--grey);">‚öôÔ∏è Cloud Configuration</h3>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
                <label style="font-size:11px; font-weight:bold;">Extra Script URL:</label>
                <input type="text" id="extUrl" placeholder="Paste secondary URL" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            </div>
            <div>
                <label style="font-size:11px; font-weight:bold;">Notification Email:</label>
                <input type="email" id="uEmail" placeholder="your@email.com" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
            </div>
        </div>
        <button style="background:var(--primary); margin-top:15px;" onclick="saveSettings()">üíæ Save & Apply Settings</button>
    </div>

    <div id="historySection" class="panel">
        <h3 style="margin-top:0; color:var(--purple);">üìã File Management</h3>
        <div class="table-container"><table><thead><tr><th>Date</th><th>File Name</th><th>Action</th></tr></thead><tbody id="histBody"></tbody></table></div>
    </div>
    
    <div id="recycleBinSection" class="panel">
        <h3 style="margin-top:0; color:var(--warning);">üóëÔ∏è Recycle Bin</h3>
        <div class="table-container"><table><thead><tr><th>Date</th><th>File Name</th><th>Action</th></tr></thead><tbody id="binBody"></tbody></table></div>
    </div>

    <h3 id="mainDataLabel">üìä Live Transactions</h3>
    <div class="table-container">
        <table id="mainDataTable"><thead id="tHead"></thead><tbody id="tBody"></tbody></table>
    </div>
</div>

<div class="overlay" id="overlay" onclick="hideAll()"></div>

<div class="modal" id="exportModal">
    <h3>Export Filter</h3>
    <label>From Date:</label>
    <input type="date" id="dateFrom" style="width:100%; margin:5px 0 15px 0; padding:8px;">
    <label>To Date:</label>
    <input type="date" id="dateTo" style="width:100%; margin:5px 0 15px 0; padding:8px;">
    <button style="background:var(--success); width:100%; padding:10px;" id="confirmExportBtn">Process Export</button>
</div>

<div class="modal" id="uploadModal">
    <h3>Upload Excel</h3>
    <input type="date" id="upDate" style="width:100%; margin-bottom:15px; padding:8px;">
    <button style="background:var(--primary); width:100%" onclick="document.getElementById('fIn').click()">Choose File</button>
</div>

<input type="file" id="fIn" hidden accept=".xlsx, .xls">

<script>
const FIXED_URL = 'https://script.google.com/macros/s/AKfycbwMA8mXLiUKv1JfEGyyU9woNg9fk2PDumMUWMyKcOdzgNTLdMmBLTf8-X8TRJ-4ZCev/exec';
let extUrl = localStorage.getItem('extUrl') || '';
let uEmail = localStorage.getItem('uEmail') || '';
let db = [];
let searchMatches = [];
let searchIdx = -1;

window.onload = () => {
    document.getElementById('extUrl').value = extUrl;
    document.getElementById('uEmail').value = uEmail;
    syncData();
};

// AUTO SCROLL LOGIC
function toggleAndScroll(id) {
    const panel = document.getElementById(id);
    const isOpening = panel.style.display !== "block";
    
    // Close others if you want cleaner look, or just toggle
    panel.style.display = isOpening ? "block" : "none";
    
    if(isOpening) {
        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function saveSettings() {
    extUrl = document.getElementById('extUrl').value.trim();
    uEmail = document.getElementById('uEmail').value.trim();
    localStorage.setItem('extUrl', extUrl);
    localStorage.setItem('uEmail', uEmail);
    alert("Settings Saved Locally!");
    syncData();
}

async function syncData() {
    updateStatus("Syncing...", "orange");
    try {
        const r = await fetch(FIXED_URL);
        db = await r.json();
        render();
        updateStatus("Live", "green");
    } catch(e) { updateStatus("Offline", "red"); }
}

function render() {
    const head = document.getElementById('tHead'), body = document.getElementById('tBody');
    const hBody = document.getElementById('histBody'), bBody = document.getElementById('binBody');
    body.innerHTML = ""; hBody.innerHTML = ""; bBody.innerHTML = "";
    if(db.length < 2) return;

    let cols = db[1][3].split(" | ");
    head.innerHTML = `<tr>${cols.map(c=>`<th>${c}</th>`).join('')}<th>Latest Comment</th><th class="no-print">Actions</th></tr>`;

    let seenFiles = new Set();
    let count = 0;

    db.forEach((row, idx) => {
        if(idx === 0) return;
        const [date, time, file, data, history, status, fileId] = row;

        if(!seenFiles.has(fileId)) {
            let target = (status === "ACTIVE") ? hBody : bBody;
            let trF = target.insertRow();
            trF.innerHTML = `<td>${date}</td><td>${file}</td><td>
                ${status === "ACTIVE" ? `<button style="background:var(--danger)" onclick="changeStatus('${fileId}','ARCHIVED')">To Bin</button>` : 
                `<button style="background:var(--success)" onclick="changeStatus('${fileId}','ACTIVE')">Restore</button>`}</td>`;
            seenFiles.add(fileId);
        }

        if(status === "ACTIVE") {
            count++;
            let tr = body.insertRow();
            data.split(" | ").forEach(val => tr.insertCell().innerText = val);
            let historyArray = history ? history.split("\n") : [];
            let latest = historyArray.length > 0 ? historyArray[historyArray.length-1].replace(/^\d+.*:\s*/, "") : "";
            let cCell = tr.insertCell();
            cCell.innerHTML = `<div id="v-${idx}">${latest}</div><input id="i-${idx}" class="comm-input" style="display:none" value="${latest}">`;
            let aCell = tr.insertCell();
            aCell.className = "no-print";
            aCell.innerHTML = `<button style="background:var(--success)" onclick="fastSave(${idx})">Save</button>
                               <button style="background:var(--warning); color:black" onclick="showEdit(${idx})">Edit</button>`;
        }
    });
    document.getElementById('activeCount').innerText = count;
}

async function fastSave(idx) {
    const input = document.getElementById(`i-${idx}`);
    const view = document.getElementById(`v-${idx}`);
    const newVal = input.value;
    view.innerText = newVal;
    view.style.display = 'block';
    input.style.display = 'none';
    updateStatus("Saving...", "blue");

    let history = db[idx][4] || "";
    let historyArray = history.split("\n").filter(x => x.trim() !== "");
    let suffix = (n) => n + (["st","nd","rd"][((n+90)%100-10)%10-1] || "th");
    let formattedComm = `${suffix(historyArray.length + 1)}: ${newVal}`;

    let payload = { action: "UPDATE_COMMENT", rowData: db[idx][3], comment: formattedComm, email: uEmail };
    fetch(FIXED_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
    if(extUrl) fetch(extUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
    setTimeout(() => updateStatus("Live", "green"), 1000);
}

// SEARCH
function initSearch() {
    let val = document.getElementById('searchInput').value.toLowerCase();
    let rows = Array.from(document.getElementById('tBody').rows);
    rows.forEach(r => r.classList.remove('highlight-row'));
    if(!val) { searchMatches = []; searchIdx = -1; return; }
    searchMatches = rows.filter(r => r.innerText.toLowerCase().includes(val));
    searchIdx = searchMatches.length > 0 ? 0 : -1;
    updateSearchUI();
}
function navSearch(dir) {
    if(!searchMatches.length) return;
    searchMatches[searchIdx]?.classList.remove('highlight-row');
    searchIdx = (searchIdx + dir + searchMatches.length) % searchMatches.length;
    updateSearchUI();
}
function updateSearchUI() {
    if(searchIdx !== -1) {
        let t = searchMatches[searchIdx];
        t.classList.add('highlight-row');
        t.scrollIntoView({ behavior: 'smooth', block: 'center' });
        document.getElementById('searchCount').innerText = `${searchIdx + 1}/${searchMatches.length}`;
    }
}

function openExportModal(type) { showModal('exportModal'); document.getElementById('confirmExportBtn').onclick = () => runExport(type); }
function runExport(type) {
    let f = document.getElementById('dateFrom').value, t = document.getElementById('dateTo').value;
    if(!f || !t) return alert("Select dates");
    let filtered = db.filter((r,i) => i>0 && r[5]==="ACTIVE" && new Date(r[0]) >= new Date(f) && new Date(r[0]) <= new Date(t));
    if(!filtered.length) return alert("No data");
    let heads = [...db[1][3].split(" | "), "Comment"];
    let data = filtered.map(r => {
        let h = r[4] ? r[4].split("\n") : [""];
        return [...r[3].split(" | "), h[h.length-1].replace(/^\d+.*:\s*/, "")];
    });
    if(type === 'excel') {
        let ws = XLSX.utils.aoa_to_sheet([heads, ...data]);
        let wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Export");
        XLSX.writeFile(wb, "Report.xlsx");
    } else if(type === 'pdf') {
        const { jsPDF } = window.jspdf;
        let doc = new jsPDF('l'); doc.autoTable({ head:[heads], body:data });
        doc.save("Report.pdf");
    }
    hideAll();
}

async function changeStatus(fid, stat) {
    let payload = { action: "CHANGE_STATUS", fileId: fid, status: stat, email: uEmail };
    fetch(FIXED_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
    if(extUrl) fetch(extUrl, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
    setTimeout(syncData, 1000);
}

function showEdit(idx) { document.getElementById(`v-${idx}`).style.display='none'; document.getElementById(`i-${idx}`).style.display='block'; document.getElementById(`i-${idx}`).focus(); }
function updateStatus(m, c) { const s = document.getElementById('syncLoader'); s.innerText = m; s.style.color = c; }
function toggleDropdown() { document.getElementById('dlMenu').classList.toggle('show'); }
function showModal(id) { document.getElementById(id).style.display='block'; document.getElementById('overlay').style.display='block'; }
function hideAll() { document.querySelectorAll('.modal, .overlay, .dropdown-content').forEach(e=>e.style.display='none'); document.querySelectorAll('.dropdown-content').forEach(e=>e.classList.remove('show')); }

document.getElementById('fIn').onchange = (e) => {
    let reader = new FileReader();
    reader.onload = (ev) => {
        let raw = XLSX.utils.sheet_to_json(XLSX.read(new Uint8Array(ev.target.result), {type:"array"}).Sheets[XLSX.read(new Uint8Array(ev.target.result), {type:"array"}).SheetNames[0]], {header:1});
        let payload = { action:"UPLOAD_FILE", fileName:e.target.files[0].name, uploadDate:document.getElementById('upDate').value, fileId:"F"+Date.now(), rows:raw.slice(1), email: uEmail };
        fetch(FIXED_URL, {method:'POST', mode:'no-cors', body:JSON.stringify(payload)});
        if(extUrl) fetch(extUrl, {method:'POST', mode:'no-cors', body:JSON.stringify(payload)});
        alert("Uploading..."); hideAll(); setTimeout(syncData, 2500);
    };
    reader.readAsArrayBuffer(e.target.files[0]);
};
</script>
</body>
</html>
